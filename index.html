<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BekoBook — соцсеть</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #121212;
    color: #eee;
    margin: 0; padding: 20px;
  }
  h1 { text-align: center; }
  .hidden { display: none; }
  input, textarea, select, button {
    background: #222;
    border: 1px solid #444;
    color: #eee;
    padding: 8px;
    margin: 5px 0;
    width: 100%;
    box-sizing: border-box;
  }
  button {
    cursor: pointer;
  }
  #loginSection, #registerSection, #mainSection {
    max-width: 400px;
    margin: 0 auto 30px auto;
    background: #1e1e1e;
    padding: 20px;
    border-radius: 8px;
  }
  #posts {
    max-width: 700px;
    margin: 0 auto;
  }
  .post {
    background: #222;
    border-radius: 6px;
    padding: 10px;
    margin-bottom: 10px;
  }
  .post-author {
    font-weight: bold;
    margin-bottom: 5px;
  }
  .post-text {
    margin-bottom: 10px;
  }
  .like-btn {
    background: #333;
    border: none;
    color: #eee;
    padding: 5px 10px;
    border-radius: 4px;
  }
  .like-btn.liked {
    background: #4caf50;
  }
  #messageSection {
    max-width: 400px;
    margin: 0 auto 30px auto;
    background: #1e1e1e;
    padding: 20px;
    border-radius: 8px;
  }
  .message {
    background: #333;
    border-radius: 6px;
    padding: 8px;
    margin-bottom: 5px;
  }
  select {
    margin-bottom: 10px;
  }
</style>
</head>
<body>
<h1>BekoBook — соцсеть</h1>

<div id="loginSection">
  <h2>Вход</h2>
  <input id="loginLogin" type="text" placeholder="Логин" />
  <input id="loginPass" type="password" placeholder="Пароль" />
  <button id="btnLogin">Войти</button>
  <p>Нет аккаунта? <button id="showRegisterBtn">Зарегистрироваться</button></p>
</div>

<div id="registerSection" class="hidden">
  <h2>Регистрация</h2>
  <input id="regLogin" type="text" placeholder="Логин" />
  <input id="regPass" type="password" placeholder="Пароль" />
  <button id="btnRegister">Зарегистрироваться</button>
  <p>Уже есть аккаунт? <button id="showLoginBtn">Войти</button></p>
</div>

<div id="mainSection" class="hidden">
  <p>Вы вошли как <span id="currentUser"></span> <button id="btnLogout">Выйти</button></p>

  <section id="newPostSection">
    <h2>Новый пост</h2>
    <textarea id="postText" rows="3" placeholder="Что у тебя нового?"></textarea>
    <button id="btnPost">Опубликовать</button>
  </section>

  <section id="postsSection">
    <h2>Посты</h2>
    <div id="posts"></div>
  </section>

  <section id="messageSection">
    <h2>Личные сообщения</h2>
    <label for="recipientSelect">Выберите получателя:</label>
    <select id="recipientSelect"></select>
    <textarea id="messageText" rows="3" placeholder="Текст сообщения"></textarea>
    <button id="btnSendMessage">Отправить</button>

    <h3>Входящие сообщения</h3>
    <div id="messages"></div>
  </section>
</div>

<script src="data.js"></script>
<script>
  // Элементы
  const loginSection = document.getElementById('loginSection');
  const registerSection = document.getElementById('registerSection');
  const mainSection = document.getElementById('mainSection');

  const loginLogin = document.getElementById('loginLogin');
  const loginPass = document.getElementById('loginPass');
  const btnLogin = document.getElementById('btnLogin');

  const regLogin = document.getElementById('regLogin');
  const regPass = document.getElementById('regPass');
  const btnRegister = document.getElementById('btnRegister');

  const showRegisterBtn = document.getElementById('showRegisterBtn');
  const showLoginBtn = document.getElementById('showLoginBtn');

  const currentUserSpan = document.getElementById('currentUser');
  const btnLogout = document.getElementById('btnLogout');

  const postText = document.getElementById('postText');
  const btnPost = document.getElementById('btnPost');
  const postsDiv = document.getElementById('posts');

  const recipientSelect = document.getElementById('recipientSelect');
  const messageText = document.getElementById('messageText');
  const btnSendMessage = document.getElementById('btnSendMessage');
  const messagesDiv = document.getElementById('messages');

  // Функции отображения блоков
  function showLogin() {
    loginSection.classList.remove('hidden');
    registerSection.classList.add('hidden');
    mainSection.classList.add('hidden');
  }
  function showRegister() {
    loginSection.classList.add('hidden');
    registerSection.classList.remove('hidden');
    mainSection.classList.add('hidden');
  }
  function showMain() {
    loginSection.classList.add('hidden');
    registerSection.classList.add('hidden');
    mainSection.classList.remove('hidden');
  }

  // Инициализация
  function init() {
    if (loggedInUser) {
      currentUserSpan.textContent = loggedInUser;
      showMain();
      refreshPosts();
      refreshUsersList();
      refreshMessages();
    } else {
      showLogin();
    }
  }

  // Обработчики
  btnLogin.onclick = () => {
    const login = loginLogin.value.trim();
    const pass = loginPass.value.trim();
    if (!login || !pass) {
      alert("Заполните логин и пароль!");
      return;
    }
    if (loginUser(login, pass)) {
      currentUserSpan.textContent = login;
      showMain();
      refreshPosts();
      refreshUsersList();
      refreshMessages();
    } else {
      alert("Неверный логин или пароль!");
    }
  };

  btnRegister.onclick = () => {
    const login = regLogin.value.trim();
    const pass = regPass.value.trim();
    if (!login || !pass) {
      alert("Заполните логин и пароль!");
      return;
    }
    if (registerUser(login, pass)) {
      alert("Регистрация прошла успешно! Войдите в аккаунт.");
      showLogin();
    } else {
      alert("Пользователь с таким логином уже существует!");
    }
  };

  showRegisterBtn.onclick = showRegister;
  showLoginBtn.onclick = showLogin;

  btnLogout.onclick = () => {
    logoutUser();
    location.reload();
  };

  btnPost.onclick = () => {
    const text = postText.value.trim();
    if (!text) {
      alert("Напишите текст поста!");
      return;
    }
    createPost(text);
    postText.value = "";
    refreshPosts();
  };

  function refreshPosts() {
    postsDiv.innerHTML = "";
    const posts = getAllPosts();
    if(posts.length === 0) postsDiv.textContent = "Постов пока нет.";
    posts.forEach(post => {
      const div = document.createElement("div");
      div.className = "post";
      div.innerHTML = `
        <div class="post-author">${post.author}</div>
        <div class="post-text">${post.text}</div>
        <button class="like-btn ${post.likedBy && post.likedBy.includes(loggedInUser) ? 'liked' : ''}" data-id="${post.id}">
          ❤️ ${post.likes}
        </button>
      `;
      postsDiv.appendChild(div);
    });

    // Вешаем события лайка
    document.querySelectorAll('.like-btn').forEach(btn => {
      btn.onclick = () => {
        const id = Number(btn.getAttribute('data-id'));
        if(likePost(id)) refreshPosts();
        else alert("Вы уже лайкали этот пост!");
      };
    });
  }

  // Обновление списка пользователей для выбора получателя
  function refreshUsersList() {
    recipientSelect.innerHTML = "";
    const usersList = getAllUserLogins().filter(u => u !== loggedInUser);
    if(usersList.length === 0) {
      const opt = document.createElement('option');
      opt.text = "Нет пользователей";
      opt.value = "";
      recipientSelect.appendChild(opt);
      recipientSelect.disabled = true;
    } else {
      recipientSelect.disabled = false;
      usersList.forEach(user => {
        const opt = document.createElement('option');
        opt.text = user;
        opt.value = user;
        recipientSelect.appendChild(opt);
      });
    }
  }

  btnSendMessage.onclick = () => {
    const recipient = recipientSelect.value;
    const text = messageText.value.trim();
    if (!recipient || !text) {
      alert("Выберите получателя и введите сообщение!");
      return;
    }
    if (!sendMessage(recipient, text)) {
      alert("Пользователь не найден или ошибка отправки!");
      return;
    }
    messageText.value = "";
    alert("Сообщение отправлено!");
    refreshMessages();
  };

  function refreshMessages() {
    messagesDiv.innerHTML = "";
    const msgs = getUserMessages();
    for (const fromUser in msgs) {
      msgs[fromUser].forEach(m => {
        const div = document.createElement("div");
        div.className = "message";
        div.innerHTML = `<strong>${fromUser}:</strong> ${m.text} <small>${new Date(m.date).toLocaleString()}</small>`;
        messagesDiv.appendChild(div);
      });
    }
    if(Object.keys(msgs).length === 0) messagesDiv.textContent = "Сообщений нет.";
  }

  init();
</script>
</body>
</html>
