<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BekoBook - Соцсеть</title>
<link rel="stylesheet" href="style.css" />
</head>
<body>

<header>BekoBook</header>

<div id="loginForm" class="form-container">
  <h2>Вход</h2>
  <input id="loginInput" type="text" placeholder="Логин" />
  <input id="passwordInput" type="password" placeholder="Пароль" />
  <button id="loginBtn">Войти</button>
  <div class="link" id="showRegisterLink">Нет аккаунта? Зарегистрируйтесь</div>
</div>

<div id="registerForm" class="form-container" style="display:none;">
  <h2>Регистрация</h2>
  <input id="registerLoginInput" type="text" placeholder="Логин" />
  <input id="registerPasswordInput" type="password" placeholder="Пароль" />
  <button id="registerBtn">Зарегистрироваться</button>
  <div class="link" id="showLoginLink">Есть аккаунт? Войдите</div>
</div>

<div id="app" class="app-container" style="display:none;">
  <h2>Привет, <span id="userName"></span>!</h2>

  <textarea id="postInput" class="post-input" placeholder="Что у вас нового?"></textarea>
  <button id="createPostBtn">Опубликовать</button>

  <div id="posts"></div>

  <h3>Личные сообщения</h3>
  <input id="messageRecipient" type="text" placeholder="Получатель" />
  <textarea id="messageInput" placeholder="Ваше сообщение" rows="3"></textarea>
  <button id="sendMessageBtn">Отправить сообщение</button>

  <div id="messages"></div>

  <button class="logout-btn" id="logoutBtn">Выйти</button>
</div>

<script type="module">
import * as data from './data.js';

const loginForm = document.getElementById("loginForm");
const registerForm = document.getElementById("registerForm");
const app = document.getElementById("app");
const userNameSpan = document.getElementById("userName");

const loginInput = document.getElementById("loginInput");
const passwordInput = document.getElementById("passwordInput");
const registerLoginInput = document.getElementById("registerLoginInput");
const registerPasswordInput = document.getElementById("registerPasswordInput");
const postInput = document.getElementById("postInput");
const messageRecipient = document.getElementById("messageRecipient");
const messageInput = document.getElementById("messageInput");
const postsDiv = document.getElementById("posts");
const messagesDiv = document.getElementById("messages");

const loginBtn = document.getElementById("loginBtn");
const registerBtn = document.getElementById("registerBtn");
const showRegisterLink = document.getElementById("showRegisterLink");
const showLoginLink = document.getElementById("showLoginLink");
const createPostBtn = document.getElementById("createPostBtn");
const sendMessageBtn = document.getElementById("sendMessageBtn");
const logoutBtn = document.getElementById("logoutBtn");

function showLoginForm() {
  loginForm.style.display = "block";
  registerForm.style.display = "none";
  app.style.display = "none";
}

function showRegisterForm() {
  loginForm.style.display = "none";
  registerForm.style.display = "block";
  app.style.display = "none";
}

function showApp() {
  loginForm.style.display = "none";
  registerForm.style.display = "none";
  app.style.display = "block";
  userNameSpan.textContent = data.getLoggedInUser();
  refreshPosts();
  refreshMessages();
}

if (data.isLoggedIn()) {
  showApp();
} else {
  showLoginForm();
}

loginBtn.onclick = () => {
  try {
    data.loginUser(loginInput.value.trim(), passwordInput.value.trim());
    showApp();
  } catch(e) {
    alert(e.message);
  }
};

registerBtn.onclick = () => {
  try {
    data.registerUser(registerLoginInput.value.trim(), registerPasswordInput.value.trim());
    alert("Регистрация успешна! Войдите.");
    showLoginForm();
  } catch(e) {
    alert(e.message);
  }
};

showRegisterLink.onclick = showRegisterForm;
showLoginLink.onclick = showLoginForm;

createPostBtn.onclick = () => {
  try {
    data.createPost(postInput.value.trim());
    postInput.value = "";
    refreshPosts();
  } catch(e) {
    alert(e.message);
  }
};

sendMessageBtn.onclick = () => {
  try {
    data.sendMessage(messageRecipient.value.trim(), messageInput.value.trim());
    messageInput.value = "";
    refreshMessages();
  } catch(e) {
    alert(e.message);
  }
};

logoutBtn.onclick = () => {
  data.logoutUser();
  showLoginForm();
};

function refreshPosts() {
  postsDiv.innerHTML = "";
  const posts = data.getPosts();
  posts.forEach(post => {
    const div = document.createElement("div");
    div.className = "post";
    const liked = post.likedBy.includes(data.getLoggedInUser());
    div.innerHTML = `
      <div class="author">${post.author}</div>
      <div>${post.text}</div>
      <div class="likes ${liked ? "liked" : ""}" data-id="${post.id}">❤️ ${post.likes} ${liked ? "(Лайкнуто)" : ""}</div>
    `;
    postsDiv.appendChild(div);
  });

  postsDiv.querySelectorAll(".likes").forEach(el => {
    el.onclick = () => {
      try {
        data.likePost(+el.dataset.id);
        refreshPosts();
      } catch(e) {
        alert(e.message);
      }
    };
  });
}

function refreshMessages() {
  messagesDiv.innerHTML = "";
  const msgs = data.getMessagesForUser(data.getLoggedInUser());
  if (msgs.length === 0) {
    messagesDiv.textContent = "Нет сообщений";
    return;
  }
  msgs.forEach(msg => {
    const div = document.createElement("div");
    div.className = "message";
    div.innerHTML = `<strong>${msg.sender}</strong>: ${msg.text}<br><small>${new Date(msg.date).toLocaleString()}</small>`;
    messagesDiv.appendChild(div);
  });
}
</script>

</body>
</html>
