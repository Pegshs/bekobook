<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ú–∏–Ω–∏-–†–æ–±–ª–æ–∫—Å</title>
  <style>
    body { font-family: sans-serif; background: #111; color: #fff; margin: 0; padding: 20px; }
    input, button, select { padding: 10px; margin: 5px; }
    .hidden { display: none; }
    .avatar { width: 50px; height: 50px; display: inline-block; margin: 5px; border-radius: 10px; }
    .player { position: absolute; width: 40px; height: 40px; border-radius: 10px; }
    canvas { background: #222; display: block; margin-top: 10px; }
  </style>
</head>
<body>

<div id="auth">
  <h2>–í—Ö–æ–¥</h2>
  <input id="login" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
  <input id="pass" placeholder="–ü–∞—Ä–æ–ª—å" type="password">
  <button onclick="login()">–í–æ–π—Ç–∏</button>
  <button onclick="switchToReg()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
</div>

<div id="reg" class="hidden">
  <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
  <input id="reg_login" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
  <input id="reg_pass" placeholder="–ü–∞—Ä–æ–ª—å" type="password">
  <button onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
  <button onclick="switchToAuth()">–ù–∞–∑–∞–¥</button>
</div>

<div id="game" class="hidden">
  <h2>–ü—Ä–∏–≤–µ—Ç, <span id="username"></span>!</h2>

  <h3>–ù–∞—Å—Ç—Ä–æ–π –∞–≤–∞—Ç–∞—Ä:</h3>
  –¶–≤–µ—Ç: <input type="color" id="colorPick">
  <button onclick="saveAvatar()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>

  <div class="avatar" id="myAvatar" style="background: gray;"></div>

  <h3>–ò–≥—Ä—ã:</h3>
  <button onclick="startBomb()">–ü–æ–±–µ–≥ –æ—Ç –±–æ–º–±</button>
  <button onclick="startPortal()">–ü–æ—Ä—Ç–∞–ª</button>

  <canvas id="gameCanvas" width="500" height="300" class="hidden"></canvas>
</div>

<script>
let users = JSON.parse(localStorage.getItem("users") || "{}")
let currentUser = null
let channel = new BroadcastChannel("roblox_clone")
let others = {}

function switchToReg() {
  document.getElementById("auth").classList.add("hidden")
  document.getElementById("reg").classList.remove("hidden")
}

function switchToAuth() {
  document.getElementById("reg").classList.add("hidden")
  document.getElementById("auth").classList.remove("hidden")
}

function register() {
  let login = document.getElementById("reg_login").value
  let pass = document.getElementById("reg_pass").value
  if (users[login]) return alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
  users[login] = { pass, avatar: "#888" }
  localStorage.setItem("users", JSON.stringify(users))
  alert("–£—Å–ø–µ—à–Ω–æ!")
  switchToAuth()
}

function login() {
  let login = document.getElementById("login").value
  let pass = document.getElementById("pass").value
  if (!users[login] || users[login].pass !== pass) return alert("–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ")
  currentUser = login
  document.getElementById("username").textContent = login
  document.getElementById("auth").classList.add("hidden")
  document.getElementById("game").classList.remove("hidden")
  document.getElementById("colorPick").value = users[login].avatar
  document.getElementById("myAvatar").style.background = users[login].avatar
  broadcastAvatar()
}

function saveAvatar() {
  let color = document.getElementById("colorPick").value
  users[currentUser].avatar = color
  localStorage.setItem("users", JSON.stringify(users))
  document.getElementById("myAvatar").style.background = color
  broadcastAvatar()
}

function broadcastAvatar() {
  channel.postMessage({ user: currentUser, avatar: users[currentUser].avatar, pos: playerPos })
}

let playerPos = { x: 100, y: 100 }

channel.onmessage = (e) => {
  if (e.data.user !== currentUser) {
    others[e.data.user] = e.data
  }
}

function drawOthers(ctx) {
  for (let [name, data] of Object.entries(others)) {
    ctx.fillStyle = data.avatar
    ctx.fillRect(data.pos.x, data.pos.y, 40, 40)
    ctx.fillStyle = "#fff"
    ctx.fillText(name, data.pos.x, data.pos.y - 5)
  }
}

function startBomb() {
  let canvas = document.getElementById("gameCanvas")
  let ctx = canvas.getContext("2d")
  canvas.classList.remove("hidden")
  let bombs = []

  setInterval(() => {
    bombs.push({ x: Math.random() * 460, y: 0 })
  }, 1000)

  document.addEventListener("keydown", (e) => {
    if (e.key === "ArrowLeft") playerPos.x -= 10
    if (e.key === "ArrowRight") playerPos.x += 10
    if (e.key === "ArrowUp") playerPos.y -= 10
    if (e.key === "ArrowDown") playerPos.y += 10
    broadcastAvatar()
  })

  function loop() {
    ctx.clearRect(0, 0, 500, 300)
    ctx.fillStyle = users[currentUser].avatar
    ctx.fillRect(playerPos.x, playerPos.y, 40, 40)

    bombs.forEach(b => {
      b.y += 2
      ctx.fillStyle = "red"
      ctx.fillRect(b.x, b.y, 10, 10)
      if (
        b.x < playerPos.x + 40 &&
        b.x + 10 > playerPos.x &&
        b.y < playerPos.y + 40 &&
        b.y + 10 > playerPos.y
      ) {
        alert("–ü–æ–ø–∞–ª –ø–æ —Ç–µ–±–µ! üòµ")
        bombs.length = 0
      }
    })

    drawOthers(ctx)
    requestAnimationFrame(loop)
  }

  loop()
}

function startPortal() {
  alert("–ü–æ–∫–∞ –ø–æ—Ä—Ç–∞–ª –Ω–µ –≥–æ—Ç–æ–≤ üòÖ, —Å–∫–æ—Ä–æ –¥–æ–±–∞–≤–ª—é!")
}
</script>

</body>
</html>
